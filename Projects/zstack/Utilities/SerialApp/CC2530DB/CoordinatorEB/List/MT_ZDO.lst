###############################################################################
#                                                                             #
# IAR C/C++ Compiler V8.10.1.10194/W32 for 8051         12/Feb/2014  16:53:05 #
# Copyright 2004-2011 IAR Systems AB.                                         #
#                                                                             #
#    Core               =  plain                                              #
#    Code model         =  banked                                             #
#    Data model         =  large                                              #
#    Calling convention =  xdata reentrant                                    #
#    Constant location  =  data_rom                                           #
#    Dptr setup         =  1,16                                               #
#    Source file        =  G:\ZStack-CC2530-V2.2\Components\mt\MT_ZDO.c       #
#    Command line       =  -f G:\ZStack-CC2530-V2.2\Projects\zstack\Utilities #
#                          \SerialApp\CC2530DB\..\..\..\Tools\CC2530DB\f8wCoo #
#                          rd.cfg (-DCPU32MHZ -DROOT=__near_func              #
#                          -DMAC_CFG_APP_PENDING_QUEUE=TRUE                   #
#                          -DMAC_CFG_TX_DATA_MAX=5 -DMAC_CFG_TX_MAX=8         #
#                          -DMAC_CFG_RX_MAX=5 -DZDO_COORDINATOR -DRTR_NWK)    #
#                          -f G:\ZStack-CC2530-V2.2\Projects\zstack\Utilities #
#                          \SerialApp\CC2530DB\..\..\..\Tools\CC2530DB\f8wCon #
#                          fig.cfg (-DZIGBEEPRO -DSECURE=0                    #
#                          -DZG_SECURE_DYNAMIC=0 -DREFLECTOR                  #
#                          -DDEFAULT_CHANLIST=0x04000000                      #
#                          -DZDAPP_CONFIG_PAN_ID=0xfff1                       #
#                          -DNWK_START_DELAY=100 -DEXTENDED_JOINING_RANDOM_MA #
#                          SK=0x007F -DBEACON_REQUEST_DELAY=100               #
#                          -DBEACON_REQ_DELAY_MASK=0x00FF                     #
#                          -DLINK_STATUS_JITTER_MASK=0x007F                   #
#                          -DROUTE_EXPIRY_TIME=30 -DAPSC_ACK_WAIT_DURATION_PO #
#                          LLED=3000 -DNWK_INDIRECT_MSG_TIMEOUT=7             #
#                          -DMAX_RREQ_ENTRIES=8 -DAPSC_MAX_FRAME_RETRIES=3    #
#                          -DNWK_MAX_DATA_RETRIES=2                           #
#                          -DMAX_POLL_FAILURE_RETRIES=2 -DMAX_BCAST=9         #
#                          -DAPS_MAX_GROUPS=16 -DMAX_RTG_ENTRIES=40           #
#                          -DNWK_MAX_BINDING_ENTRIES=4                        #
#                          -DMAX_BINDING_CLUSTER_IDS=4 "-DDEFAULT_KEY={0x01,  #
#                          0x03, 0x05, 0x07, 0x09, 0x0B, 0x0D, 0x0F, 0x00,    #
#                          0x02, 0x04, 0x06, 0x08, 0x0A, 0x0C, 0x0D}"         #
#                          -DMAC_MAX_FRAME_SIZE=116                           #
#                          -DZDNWKMGR_MIN_TRANSMISSIONS=20 "-DCONST=const     #
#                          __code" -DGENERIC=__generic                        #
#                          -DRFD_RCVC_ALWAYS_ON=FALSE -DPOLL_RATE=1000        #
#                          -DQUEUED_POLL_RATE=100 -DRESPONSE_POLL_RATE=100)   #
#                          -DREJOIN_POLL_RATE=440 G:\ZStack-CC2530-V2.2\Compo #
#                          nents\mt\MT_ZDO.c -D HAL_UART=TRUE -D              #
#                          SERIAL_APP_PORT=0 -D LCD_SUPPORTED -lC             #
#                          G:\ZStack-CC2530-V2.2\Projects\zstack\Utilities\Se #
#                          rialApp\CC2530DB\CoordinatorEB\List\ -lA           #
#                          G:\ZStack-CC2530-V2.2\Projects\zstack\Utilities\Se #
#                          rialApp\CC2530DB\CoordinatorEB\List\               #
#                          --diag_suppress Pe001,Pa010 -o                     #
#                          G:\ZStack-CC2530-V2.2\Projects\zstack\Utilities\Se #
#                          rialApp\CC2530DB\CoordinatorEB\Obj\ -e             #
#                          --no_code_motion --debug --core=plain --dptr=16,1  #
#                          --data_model=large --code_model=banked             #
#                          --calling_convention=xdata_reentrant               #
#                          --place_constants=data_rom --nr_virtual_regs 16    #
#                          -I G:\ZStack-CC2530-V2.2\Projects\zstack\Utilities #
#                          \SerialApp\CC2530DB\ -I G:\ZStack-CC2530-V2.2\Proj #
#                          ects\zstack\Utilities\SerialApp\CC2530DB\..\Source #
#                          \ -I G:\ZStack-CC2530-V2.2\Projects\zstack\Utiliti #
#                          es\SerialApp\CC2530DB\..\..\..\ZMain\TI2530DB\ -I  #
#                          G:\ZStack-CC2530-V2.2\Projects\zstack\Utilities\Se #
#                          rialApp\CC2530DB\..\..\..\..\..\Components\hal\inc #
#                          lude\ -I G:\ZStack-CC2530-V2.2\Projects\zstack\Uti #
#                          lities\SerialApp\CC2530DB\..\..\..\..\..\Component #
#                          s\hal\target\CC2530EB\ -I                          #
#                          G:\ZStack-CC2530-V2.2\Projects\zstack\Utilities\Se #
#                          rialApp\CC2530DB\..\..\..\..\..\Components\mac\inc #
#                          lude\ -I G:\ZStack-CC2530-V2.2\Projects\zstack\Uti #
#                          lities\SerialApp\CC2530DB\..\..\..\..\..\Component #
#                          s\mac\high_level\ -I G:\ZStack-CC2530-V2.2\Project #
#                          s\zstack\Utilities\SerialApp\CC2530DB\..\..\..\..\ #
#                          ..\Components\mac\low_level\srf04\ -I              #
#                          G:\ZStack-CC2530-V2.2\Projects\zstack\Utilities\Se #
#                          rialApp\CC2530DB\..\..\..\..\..\Components\mac\low #
#                          _level\srf04\single_chip\ -I                       #
#                          G:\ZStack-CC2530-V2.2\Projects\zstack\Utilities\Se #
#                          rialApp\CC2530DB\..\..\..\..\..\Components\mt\ -I  #
#                          G:\ZStack-CC2530-V2.2\Projects\zstack\Utilities\Se #
#                          rialApp\CC2530DB\..\..\..\..\..\Components\osal\in #
#                          clude\ -I G:\ZStack-CC2530-V2.2\Projects\zstack\Ut #
#                          ilities\SerialApp\CC2530DB\..\..\..\..\..\Componen #
#                          ts\services\saddr\ -I G:\ZStack-CC2530-V2.2\Projec #
#                          ts\zstack\Utilities\SerialApp\CC2530DB\..\..\..\.. #
#                          \..\Components\services\sdata\ -I                  #
#                          G:\ZStack-CC2530-V2.2\Projects\zstack\Utilities\Se #
#                          rialApp\CC2530DB\..\..\..\..\..\Components\stack\a #
#                          f\ -I G:\ZStack-CC2530-V2.2\Projects\zstack\Utilit #
#                          ies\SerialApp\CC2530DB\..\..\..\..\..\Components\s #
#                          tack\nwk\ -I G:\ZStack-CC2530-V2.2\Projects\zstack #
#                          \Utilities\SerialApp\CC2530DB\..\..\..\..\..\Compo #
#                          nents\stack\sapi\ -I G:\ZStack-CC2530-V2.2\Project #
#                          s\zstack\Utilities\SerialApp\CC2530DB\..\..\..\..\ #
#                          ..\Components\stack\sec\ -I                        #
#                          G:\ZStack-CC2530-V2.2\Projects\zstack\Utilities\Se #
#                          rialApp\CC2530DB\..\..\..\..\..\Components\stack\s #
#                          ys\ -I G:\ZStack-CC2530-V2.2\Projects\zstack\Utili #
#                          ties\SerialApp\CC2530DB\..\..\..\..\..\Components\ #
#                          stack\zdo\ -I G:\ZStack-CC2530-V2.2\Projects\zstac #
#                          k\Utilities\SerialApp\CC2530DB\..\..\..\..\..\Comp #
#                          onents\zmac\ -I G:\ZStack-CC2530-V2.2\Projects\zst #
#                          ack\Utilities\SerialApp\CC2530DB\..\..\..\..\..\Co #
#                          mponents\zmac\f8w\ -Ohz --require_prototypes       #
#    List file          =  G:\ZStack-CC2530-V2.2\Projects\zstack\Utilities\Se #
#                          rialApp\CC2530DB\CoordinatorEB\List\MT_ZDO.lst     #
#    Object file        =  G:\ZStack-CC2530-V2.2\Projects\zstack\Utilities\Se #
#                          rialApp\CC2530DB\CoordinatorEB\Obj\MT_ZDO.r51      #
#                                                                             #
#                                                                             #
###############################################################################

G:\ZStack-CC2530-V2.2\Components\mt\MT_ZDO.c
      1          /**************************************************************************************************
      2            Filename:       MT_ZDO.c
      3            Revised:        $Date: 2011-06-07 14:34:55 -0700 (Tue, 07 Jun 2011) $
      4            Revision:       $Revision: 26241 $
      5          
      6            Description:    MonitorTest functions for the ZDO layer.
      7          
      8          
      9            Copyright 2004-2011 Texas Instruments Incorporated. All rights reserved.
     10          
     11            IMPORTANT: Your use of this Software is limited to those specific rights
     12            granted under the terms of a software license agreement between the user
     13            who downloaded the software, his/her employer (which must be your employer)
     14            and Texas Instruments Incorporated (the "License").  You may not use this
     15            Software unless you agree to abide by the terms of the License. The License
     16            limits your use, and you acknowledge, that the Software may not be modified,
     17            copied or distributed unless embedded on a Texas Instruments microcontroller
     18            or used solely and exclusively in conjunction with a Texas Instruments radio
     19            frequency transceiver, which is integrated into your product.  Other than for
     20            the foregoing purpose, you may not use, reproduce, copy, prepare derivative
     21            works of, modify, distribute, perform, display or sell this Software and/or
     22            its documentation for any purpose.
     23          
     24            YOU FURTHER ACKNOWLEDGE AND AGREE THAT THE SOFTWARE AND DOCUMENTATION ARE
     25            PROVIDED “AS IS” WITHOUT WARRANTY OF ANY KIND, EITHER EXPRESS OR IMPLIED,
     26            INCLUDING WITHOUT LIMITATION, ANY WARRANTY OF MERCHANTABILITY, TITLE,
     27            NON-INFRINGEMENT AND FITNESS FOR A PARTICULAR PURPOSE. IN NO EVENT SHALL
     28            TEXAS INSTRUMENTS OR ITS LICENSORS BE LIABLE OR OBLIGATED UNDER CONTRACT,
     29            NEGLIGENCE, STRICT LIABILITY, CONTRIBUTION, BREACH OF WARRANTY, OR OTHER
     30            LEGAL EQUITABLE THEORY ANY DIRECT OR INDIRECT DAMAGES OR EXPENSES
     31            INCLUDING BUT NOT LIMITED TO ANY INCIDENTAL, SPECIAL, INDIRECT, PUNITIVE
     32            OR CONSEQUENTIAL DAMAGES, LOST PROFITS OR LOST DATA, COST OF PROCUREMENT
     33            OF SUBSTITUTE GOODS, TECHNOLOGY, SERVICES, OR ANY CLAIMS BY THIRD PARTIES
     34            (INCLUDING BUT NOT LIMITED TO ANY DEFENSE THEREOF), OR OTHER SIMILAR COSTS.
     35          
     36            Should you have any questions regarding your right to use this Software,
     37            contact Texas Instruments Incorporated at www.TI.com.
     38          **************************************************************************************************/
     39          
     40          #ifdef MT_ZDO_FUNC
     41          
     42          /**************************************************************************************************
     43           * INCLUDES
     44           **************************************************************************************************/
     45          #include "ZComDef.h"
     46          #include "OSAL.h"
     47          #include "OSAL_Nv.h"
     48          #include "MT.h"
     49          #include "MT_ZDO.h"
     50          #include "APSMEDE.h"
     51          #include "ZDConfig.h"
     52          #include "ZDProfile.h"
     53          #include "ZDObject.h"
     54          #include "ZDApp.h"
     55          
     56          #if !defined( WIN32 )
     57            #include "OnBoard.h"
     58          #endif
     59          
     60          #if defined ( MT_SYS_KEY_MANAGEMENT )
     61            #include "ZDSecMgr.h"
     62          #endif
     63          
     64          #include "nwk_util.h"
     65          
     66          /**************************************************************************************************
     67           * CONSTANTS
     68           **************************************************************************************************/
     69          #define MT_ZDO_END_DEVICE_ANNCE_IND_LEN   0x0D
     70          #define MT_ZDO_ADDR_RSP_LEN               0x0D
     71          #define MT_ZDO_BIND_UNBIND_RSP_LEN        0x03
     72          #define MT_ZDO_BEACON_IND_LEN             21
     73          #define MT_ZDO_BEACON_IND_PACK_LEN        (MT_UART_TX_BUFF_MAX - SPI_0DATA_MSG_LEN)
     74          #define MT_ZDO_JOIN_CNF_LEN               5
     75          
     76          // Message must pack nwk addr, entire (not just pointer to) ieee addr, and packet cost, so the
     77          // sizeof(zdoConcentratorInd_t) is not usable.
     78          #define MT_ZDO_CONCENTRATOR_IND_LEN      (2 + Z_EXTADDR_LEN + 1)
     79          
     80          #define MTZDO_RESPONSE_BUFFER_LEN   100
     81          
     82          #define MTZDO_MAX_MATCH_CLUSTERS    16
     83          #define MTZDO_MAX_ED_BIND_CLUSTERS  15
     84          
     85          // Conversion from ZDO Cluster Id to the RPC AREQ Id is direct as follows:
     86          #define MT_ZDO_CID_TO_AREQ_ID(CId)  ((uint8)(CId) | 0x80)
     87          
     88          #define MT_ZDO_STATUS_LEN   1
     89          
     90          /**************************************************************************************************
     91           * GLOBAL VARIABLES
     92           **************************************************************************************************/
     93          uint32 _zdoCallbackSub;
     94          uint8 *pBeaconIndBuf = NULL;
     95          
     96          /**************************************************************************************************
     97           * LOCAL VARIABLES
     98           **************************************************************************************************/
     99          
    100          /**************************************************************************************************
    101           * LOCAL FUNCTIONS
    102           **************************************************************************************************/
    103          #if defined (MT_ZDO_FUNC)
    104          void MT_ZdoNWKAddressRequest(uint8 *pBuf);
    105          void MT_ZdoIEEEAddrRequest(uint8 *pBuf);
    106          void MT_ZdoNodeDescRequest(uint8 *pBuf);
    107          void MT_ZdoPowerDescRequest(uint8 *pBuf);
    108          void MT_ZdoSimpleDescRequest(uint8 *pBuf);
    109          void MT_ZdoActiveEpRequest(uint8 *pBuf);
    110          void MT_ZdoMatchDescRequest(uint8 *pBuf);
    111          void MT_ZdoComplexDescRequest(uint8 *pBuf);
    112          void MT_ZdoUserDescRequest(uint8 *pBuf);
    113          void MT_ZdoEndDevAnnce(uint8 *pBuf);
    114          void MT_ZdoUserDescSet(uint8 *pBuf);
    115          void MT_ZdoServiceDiscRequest(uint8 *pBuf);
    116          void MT_ZdoEndDevBindRequest(uint8 *pBuf);
    117          void MT_ZdoBindRequest(uint8 *pBuf);
    118          void MT_ZdoUnbindRequest(uint8 *pBuf);
    119          void MT_ZdoMgmtNwkDiscRequest(uint8 *pBuf);
    120          #if defined ( MT_SYS_KEY_MANAGEMENT )
    121          void MT_ZdoSetLinkKey(uint8 *pBuf);
    122          void MT_ZdoRemoveLinkKey(uint8 *pBuf);
    123          void MT_ZdoGetLinkKey(uint8 *pBuf);
    124          #endif /* MT_SYS_KEY_MANAGEMENT */
    125          void MT_ZdoNetworkDiscoveryReq(uint8 *pBuf);
    126          void MT_ZdoJoinReq(uint8 *pBuf);
    127          /* Call back function */
    128          void *MT_ZdoNwkDiscoveryCnfCB ( void *pStr );
    129          void *MT_ZdoBeaconIndCB ( void *pStr );
    130          void *MT_ZdoJoinCnfCB ( void *pStr );
    131          #if defined (MT_ZDO_MGMT)
    132          void MT_ZdoMgmtLqiRequest(uint8 *pBuf);
    133          void MT_ZdoMgmtRtgRequest(uint8 *pBuf);
    134          void MT_ZdoMgmtBindRequest(uint8 *pBuf);
    135          void MT_ZdoMgmtLeaveRequest(uint8 *pBuf);
    136          void MT_ZdoMgmtDirectJoinRequest(uint8 *pBuf);
    137          void MT_ZdoMgmtPermitJoinRequest(uint8 *pBuf);
    138          void MT_ZdoMgmtNwkUpdateRequest(uint8 *pBuf);
    139          #endif /* MT_ZDO_MGMT */
    140          void MT_ZdoStartupFromApp(uint8 *pBuf);
    141          void MT_ZdoRegisterForZDOMsg(uint8 *pBuf);
    142          void MT_ZdoRemoveRegisteredCB(uint8 *pBuf);
    143          #endif /* MT_ZDO_FUNC */
    144          
    145          #if defined (MT_ZDO_CB_FUNC)
    146          uint8 MT_ZdoHandleExceptions( afIncomingMSGPacket_t *pData, zdoIncomingMsg_t *inMsg );
    147          void MT_ZdoAddrRspCB( ZDO_NwkIEEEAddrResp_t *pMsg, uint16 clusterID );
    148          void MT_ZdoEndDevAnnceCB( ZDO_DeviceAnnce_t *pMsg, uint16 srcAddr );
    149          void MT_ZdoBindUnbindRspCB( uint16 clusterID, uint16 srcAddr, uint8 status );
    150          void* MT_ZdoSrcRtgCB( void *pStr );
    151          static void *MT_ZdoConcentratorIndCB(void *pStr);
    152          #endif /* MT_ZDO_CB_FUNC */
    153          
    154          #if defined (MT_ZDO_FUNC)
    155          /***************************************************************************************************
    156           * @fn      MT_ZdoInit
    157           *
    158           * @brief   MT ZDO initialization
    159           *
    160           * @param   none
    161           *
    162           * @return  none
    163           ***************************************************************************************************/
    164          void MT_ZdoInit(void)
    165          {
    166          #ifdef MT_ZDO_CB_FUNC
    167            /* Register with ZDO for indication callbacks */
    168            ZDO_RegisterForZdoCB(ZDO_SRC_RTG_IND_CBID, &MT_ZdoSrcRtgCB);
    169            ZDO_RegisterForZdoCB(ZDO_CONCENTRATOR_IND_CBID, &MT_ZdoConcentratorIndCB);
    170          #endif
    171          }
    172          
    173          /***************************************************************************************************
    174           * @fn      MT_ZdoCommandProcessing
    175           *
    176           * @brief
    177           *
    178           *   Process all the ZDO commands that are issued by test tool
    179           *
    180           * @param   pBuf - pointer to the msg buffer
    181           *
    182           *          | LEN  | CMD0  | CMD1  |  DATA  |
    183           *          |  1   |   1   |   1   |  0-255 |
    184           *
    185           * @return  status
    186           ***************************************************************************************************/
    187          uint8 MT_ZdoCommandProcessing(uint8* pBuf)
    188          {
    189            uint8 status = MT_RPC_SUCCESS;
    190          
    191            switch (pBuf[MT_RPC_POS_CMD1])
    192            {
    193          #if defined ( ZDO_NWKADDR_REQUEST )
    194              case MT_ZDO_NWK_ADDR_REQ:
    195                MT_ZdoNWKAddressRequest(pBuf);
    196                break;
    197          #endif
    198          
    199          #if defined ( ZDO_IEEEADDR_REQUEST )
    200              case MT_ZDO_IEEE_ADDR_REQ:
    201                MT_ZdoIEEEAddrRequest(pBuf);
    202                break;
    203          #endif
    204          
    205          #if defined ( ZDO_NODEDESC_REQUEST )
    206              case MT_ZDO_NODE_DESC_REQ:
    207                MT_ZdoNodeDescRequest(pBuf);
    208                break;
    209          #endif
    210          
    211          #if defined ( ZDO_POWERDESC_REQUEST )
    212              case MT_ZDO_POWER_DESC_REQ:
    213                MT_ZdoPowerDescRequest(pBuf);
    214                break;
    215          #endif
    216          
    217          #if defined ( ZDO_SIMPLEDESC_REQUEST )
    218              case MT_ZDO_SIMPLE_DESC_REQ:
    219                MT_ZdoSimpleDescRequest(pBuf);
    220                break;
    221          #endif
    222          
    223          #if defined ( ZDO_ACTIVEEP_REQUEST )
    224              case MT_ZDO_ACTIVE_EP_REQ:
    225                MT_ZdoActiveEpRequest(pBuf);
    226                break;
    227          #endif
    228          
    229          #if defined ( ZDO_MATCH_REQUEST )
    230              case MT_ZDO_MATCH_DESC_REQ:
    231                MT_ZdoMatchDescRequest(pBuf);
    232                break;
    233          #endif
    234          
    235          #if defined ( ZDO_COMPLEXDESC_REQUEST )
    236              case MT_ZDO_COMPLEX_DESC_REQ:
    237                MT_ZdoComplexDescRequest(pBuf);
    238                break;
    239          #endif
    240          
    241          #if defined ( ZDO_USERDESC_REQUEST )
    242              case MT_ZDO_USER_DESC_REQ:
    243                MT_ZdoUserDescRequest(pBuf);
    244                break;
    245          #endif
    246          
    247          #if defined ( ZDO_ENDDEVICE_ANNCE )
    248              case MT_ZDO_END_DEV_ANNCE:
    249                MT_ZdoEndDevAnnce(pBuf);
    250                break;
    251          #endif
    252          
    253          #if defined ( ZDO_USERDESCSET_REQUEST )
    254              case MT_ZDO_USER_DESC_SET:
    255                MT_ZdoUserDescSet(pBuf);
    256                break;
    257          #endif
    258          
    259          #if defined ( ZDO_SERVERDISC_REQUEST )
    260              case MT_ZDO_SERVICE_DISC_REQ:
    261                MT_ZdoServiceDiscRequest(pBuf);
    262                break;
    263          #endif
    264          
    265          #if defined ( ZDO_ENDDEVICEBIND_REQUEST )
    266              case MT_ZDO_END_DEV_BIND_REQ:
    267                MT_ZdoEndDevBindRequest(pBuf);
    268                break;
    269          #endif
    270          
    271          #if defined ( ZDO_BIND_UNBIND_REQUEST )
    272              case MT_ZDO_BIND_REQ:
    273                MT_ZdoBindRequest(pBuf);
    274                break;
    275          #endif
    276          
    277          #if defined ( ZDO_BIND_UNBIND_REQUEST )
    278              case MT_ZDO_UNBIND_REQ:
    279                MT_ZdoUnbindRequest(pBuf);
    280                break;
    281          #endif
    282          
    283          #if defined ( MT_SYS_KEY_MANAGEMENT )
    284              case MT_ZDO_SET_LINK_KEY:
    285                MT_ZdoSetLinkKey(pBuf);
    286                break;
    287          
    288              case MT_ZDO_REMOVE_LINK_KEY:
    289                MT_ZdoRemoveLinkKey(pBuf);
    290                break;
    291          
    292              case MT_ZDO_GET_LINK_KEY:
    293                MT_ZdoGetLinkKey(pBuf);
    294                break;
    295          #endif // MT_SYS_KEY_MANAGEMENT
    296          
    297          #if defined ( ZDO_MANUAL_JOIN )
    298              case MT_ZDO_NWK_DISCOVERY_REQ:
    299                MT_ZdoNetworkDiscoveryReq(pBuf);
    300                break;
    301          
    302              case MT_ZDO_JOIN_REQ:
    303                MT_ZdoJoinReq(pBuf);
    304                break;
    305          #endif
    306          
    307          #if defined ( ZDO_MGMT_NWKDISC_REQUEST )
    308              case MT_ZDO_MGMT_NWKDISC_REQ:
    309                MT_ZdoMgmtNwkDiscRequest(pBuf);
    310                break;
    311          #endif
    312          
    313          #if defined ( ZDO_MGMT_LQI_REQUEST )
    314              case MT_ZDO_MGMT_LQI_REQ:
    315                MT_ZdoMgmtLqiRequest(pBuf);
    316                break;
    317          #endif
    318          
    319          #if defined ( ZDO_MGMT_RTG_REQUEST )
    320              case MT_ZDO_MGMT_RTG_REQ:
    321                MT_ZdoMgmtRtgRequest(pBuf);
    322                break;
    323          #endif
    324          
    325          #if defined ( ZDO_MGMT_BIND_REQUEST )
    326              case MT_ZDO_MGMT_BIND_REQ:
    327                MT_ZdoMgmtBindRequest(pBuf);
    328                break;
    329          #endif
    330          
    331          #if defined ( ZDO_MGMT_LEAVE_REQUEST )
    332              case MT_ZDO_MGMT_LEAVE_REQ:
    333                MT_ZdoMgmtLeaveRequest(pBuf);
    334                break;
    335          #endif
    336          
    337          #if defined ( ZDO_MGMT_JOINDIRECT_REQUEST )
    338              case MT_ZDO_MGMT_DIRECT_JOIN_REQ:
    339                MT_ZdoMgmtDirectJoinRequest(pBuf);
    340                break;
    341          #endif
    342          
    343          #if defined ( ZDO_MGMT_PERMIT_JOIN_REQUEST )
    344              case MT_ZDO_MGMT_PERMIT_JOIN_REQ:
    345                MT_ZdoMgmtPermitJoinRequest(pBuf);
    346                break;
    347          #endif
    348          
    349          #if defined ( ZDO_MGMT_NWKUPDATE_REQUEST )
    350              case MT_ZDO_MGMT_NWK_UPDATE_REQ:
    351                MT_ZdoMgmtNwkUpdateRequest(pBuf);
    352                break;
    353          #endif
    354          
    355          #if defined ( ZDO_NETWORKSTART_REQUEST )
    356              case MT_ZDO_STARTUP_FROM_APP:
    357                MT_ZdoStartupFromApp(pBuf);
    358                break;
    359          #endif
    360          
    361              case MT_ZDO_MSG_CB_REGISTER:
    362                MT_ZdoRegisterForZDOMsg(pBuf);
    363                break;
    364          
    365              case MT_ZDO_MSG_CB_REMOVE:
    366                MT_ZdoRemoveRegisteredCB(pBuf);
    367                break;
    368          
    369              default:
    370                status = MT_RPC_ERR_COMMAND_ID;
    371                break;
    372            }
    373          
    374            return status;
    375          }
    376          
    377          /***************************************************************************************************
    378           * @fn      MT_ZdoNwkAddrReq
    379           *
    380           * @brief   Handle a nwk address request.
    381           *
    382           * @param   pData  - MT message data
    383           *
    384           * @return  void
    385           ***************************************************************************************************/
    386          void MT_ZdoNWKAddressRequest(uint8 *pBuf)
    387          {
    388            uint8 cmdId;
    389            uint8 retValue;
    390            uint8 reqType;
    391            uint8 startIndex;
    392            uint8 *pExtAddr;
    393          
    394            /* parse header */
    395            cmdId = pBuf[MT_RPC_POS_CMD1];
    396            pBuf += MT_RPC_FRAME_HDR_SZ;
    397          
    398            /* parse parameters */
    399            pExtAddr = pBuf;
    400            pBuf += Z_EXTADDR_LEN;
    401          
    402            /* Request type */
    403            reqType = *pBuf++;
    404          
    405            /* Start index */
    406            startIndex = *pBuf;
    407          
    408            retValue = (uint8)ZDP_NwkAddrReq(pExtAddr, reqType, startIndex, 0);
    409          
    410            /* Build and send back the response */
    411            MT_BuildAndSendZToolResponse(((uint8)MT_RPC_CMD_SRSP | (uint8)MT_RPC_SYS_ZDO), cmdId, 1, &retValue);
    412          }
    413          
    414          /***************************************************************************************************
    415           * @fn      MT_ZdoIEEEAddrRequest
    416           *
    417           * @brief   Handle a IEEE address request.
    418           *
    419           * @param   pData  - MT message data
    420           *
    421           * @return  void
    422           ***************************************************************************************************/
    423          void MT_ZdoIEEEAddrRequest (uint8 *pBuf)
    424          {
    425            uint8 cmdId;
    426            uint8 retValue;
    427            uint16 shortAddr;
    428            uint8 reqType;
    429            uint8 startIndex;
    430          
    431            /* parse header */
    432            cmdId = pBuf[MT_RPC_POS_CMD1];
    433            pBuf += MT_RPC_FRAME_HDR_SZ;
    434          
    435            /* Dev address */
    436            shortAddr = BUILD_UINT16(pBuf[0], pBuf[1]);
    437            pBuf += 2;
    438          
    439            /* request type */
    440            reqType = *pBuf++;
    441          
    442            /* start index */
    443            startIndex = *pBuf;
    444          
    445            retValue = (uint8)ZDP_IEEEAddrReq(shortAddr, reqType, startIndex, 0);
    446          
    447            MT_BuildAndSendZToolResponse(((uint8)MT_RPC_CMD_SRSP | (uint8)MT_RPC_SYS_ZDO), cmdId, 1, &retValue);
    448          }
    449          
    450          /***************************************************************************************************
    451           * @fn      MT_ZdoNodeDescRequest
    452           *
    453           * @brief   Handle a Node Descriptor request.
    454           *
    455           * @param   pData  - MT message data
    456           *
    457           * @return  void
    458           ***************************************************************************************************/
    459          void MT_ZdoNodeDescRequest (uint8 *pBuf)
    460          {
    461            uint8 cmdId;
    462            uint8 retValue;
    463            zAddrType_t destAddr;
    464            uint16 shortAddr;
    465          
    466            /* parse header */
    467            cmdId = pBuf[MT_RPC_POS_CMD1];
    468            pBuf += MT_RPC_FRAME_HDR_SZ;
    469          
    470            /* Destination address */
    471            destAddr.addrMode = Addr16Bit;
    472            destAddr.addr.shortAddr = BUILD_UINT16( pBuf[0], pBuf[1] );
    473            pBuf += 2;
    474          
    475            /* Network address of interest */
    476            shortAddr = BUILD_UINT16( pBuf[0], pBuf[1] );
    477            pBuf += 2;
    478          
    479            retValue = (uint8)ZDP_NodeDescReq( &destAddr, shortAddr, 0);
    480          
    481            MT_BuildAndSendZToolResponse(((uint8)MT_RPC_CMD_SRSP | (uint8)MT_RPC_SYS_ZDO), cmdId, 1, &retValue);
    482          }
    483          
    484          /***************************************************************************************************
    485           * @fn      MT_ZdoPowerDescRequest
    486           *
    487           * @brief   Handle a Power Descriptor request.
    488           *
    489           * @param   pData  - MT message data
    490           *
    491           * @return  void
    492           ***************************************************************************************************/
    493          void MT_ZdoPowerDescRequest(uint8 *pBuf)
    494          {
    495            uint8 cmdId;
    496            uint8 retValue;
    497            zAddrType_t destAddr;
    498            uint16 shortAddr;
    499          
    500            /* parse header */
    501            cmdId = pBuf[MT_RPC_POS_CMD1];
    502            pBuf += MT_RPC_FRAME_HDR_SZ;
    503          
    504            /* Dev address */
    505            destAddr.addrMode = Addr16Bit;
    506            destAddr.addr.shortAddr = BUILD_UINT16( pBuf[0], pBuf[1] );
    507            pBuf += 2;
    508          
    509            /* Network address of interest */
    510            shortAddr = BUILD_UINT16( pBuf[0], pBuf[1] );
    511            pBuf += 2;
    512          
    513            retValue = (uint8)ZDP_PowerDescReq( &destAddr, shortAddr, 0);
    514          
    515            MT_BuildAndSendZToolResponse(((uint8)MT_RPC_CMD_SRSP | (uint8)MT_RPC_SYS_ZDO), cmdId, 1, &retValue);
    516          }
    517          
    518          /***************************************************************************************************
    519           * @fn      MT_ZdoSimpleDescRequest
    520           *
    521           * @brief   Handle a Simple Descriptor request.
    522           *
    523           * @param   pBuf  - MT message data
    524           *
    525           * @return  void
    526           ***************************************************************************************************/
    527          void MT_ZdoSimpleDescRequest(uint8 *pBuf)
    528          {
    529            uint8 cmdId;
    530            uint8 retValue;
    531            uint8 epInt;
    532            zAddrType_t destAddr;
    533            uint16 shortAddr;
    534          
    535            /* parse header */
    536            cmdId = pBuf[MT_RPC_POS_CMD1];
    537            pBuf += MT_RPC_FRAME_HDR_SZ;
    538          
    539            /* Dev address */
    540            destAddr.addrMode = Addr16Bit;
    541            destAddr.addr.shortAddr = BUILD_UINT16( pBuf[0], pBuf[1] );
    542            pBuf += 2;
    543          
    544            /* Network address of interest */
    545            shortAddr = BUILD_UINT16( pBuf[0], pBuf[1] );
    546            pBuf += 2;
    547          
    548            /* endpoint/interface */
    549            epInt = *pBuf++;
    550          
    551            retValue = (uint8)ZDP_SimpleDescReq( &destAddr, shortAddr, epInt, 0);
    552          
    553            MT_BuildAndSendZToolResponse(((uint8)MT_RPC_CMD_SRSP | (uint8)MT_RPC_SYS_ZDO), cmdId, 1, &retValue);
    554          }
    555          
    556          /***************************************************************************************************
    557           * @fn      MT_ZdoActiveEpRequest
    558           *
    559           * @brief   Handle a Active EP request.
    560           *
    561           * @param   pBuf  - MT message data
    562           *
    563           * @return  void
    564           ***************************************************************************************************/
    565          void MT_ZdoActiveEpRequest(uint8 *pBuf)
    566          {
    567            uint8 cmdId;
    568            uint8 retValue;
    569            zAddrType_t destAddr;
    570            uint16 shortAddr;
    571          
    572            /* parse header */
    573            cmdId = pBuf[MT_RPC_POS_CMD1];
    574            pBuf += MT_RPC_FRAME_HDR_SZ;
    575          
    576            /* Dev address */
    577            destAddr.addrMode = Addr16Bit;
    578            destAddr.addr.shortAddr = BUILD_UINT16( pBuf[0], pBuf[1] );
    579            pBuf += 2;
    580          
    581            /* Network address of interest */
    582            shortAddr = BUILD_UINT16( pBuf[0], pBuf[1] );
    583            pBuf += 2;
    584          
    585            retValue = (uint8)ZDP_ActiveEPReq( &destAddr, shortAddr, 0);
    586          
    587            MT_BuildAndSendZToolResponse(((uint8)MT_RPC_CMD_SRSP | (uint8)MT_RPC_SYS_ZDO), cmdId, 1, &retValue);
    588          }
    589          
    590          /***************************************************************************************************
    591           * @fn      MT_ZdoMatchDescRequest
    592           *
    593           * @brief   Handle a Match Descriptor request.
    594           *
    595           * @param   pBuf  - MT message data
    596           *
    597           * @return  void
    598           ***************************************************************************************************/
    599          void MT_ZdoMatchDescRequest(uint8 *pBuf)
    600          {
    601            uint8 cmdId;
    602            uint8 retValue = 0;
    603            uint8 i, numInClusters, numOutClusters;
    604            uint16 profileId;
    605            zAddrType_t destAddr;
    606            uint16 shortAddr;
    607            uint16 inClusters[MTZDO_MAX_MATCH_CLUSTERS], outClusters[MTZDO_MAX_MATCH_CLUSTERS];
    608          
    609            /* parse header */
    610            cmdId = pBuf[MT_RPC_POS_CMD1];
    611            pBuf += MT_RPC_FRAME_HDR_SZ;
    612          
    613            /* Dev address */
    614            destAddr.addrMode = Addr16Bit;
    615            destAddr.addr.shortAddr = BUILD_UINT16( pBuf[0], pBuf[1] );
    616            pBuf += 2;
    617          
    618            /* Network address of interest */
    619            shortAddr = BUILD_UINT16( pBuf[0], pBuf[1] );
    620            pBuf += 2;
    621          
    622            /* Profile ID */
    623            profileId = BUILD_UINT16( pBuf[0], pBuf[1] );
    624            pBuf += 2;
    625          
    626            /* NumInClusters */
    627            numInClusters = *pBuf++;
    628            if ( numInClusters <= MTZDO_MAX_MATCH_CLUSTERS )
    629            {
    630              /* IN clusters */
    631              for ( i = 0; i < numInClusters; i++ )
    632              {
    633                inClusters[i] = BUILD_UINT16( pBuf[0], pBuf[1]);
    634                pBuf += 2;
    635              }
    636            }
    637            else
    638            {
    639              retValue = ZDP_INVALID_REQTYPE;
    640            }
    641          
    642            /* NumOutClusters */
    643            numOutClusters = *pBuf++;
    644            if ( numOutClusters <= MTZDO_MAX_MATCH_CLUSTERS )
    645            {
    646              /* OUT Clusters */
    647              for ( i = 0; i < numOutClusters; i++ )
    648              {
    649                outClusters[i] = BUILD_UINT16( pBuf[0], pBuf[1]);
    650                pBuf += 2;
    651              }
    652            }
    653            else
    654            {
    655              retValue = ZDP_INVALID_REQTYPE;
    656            }
    657          
    658            if ( retValue == 0 )
    659            {
    660              retValue = (uint8)ZDP_MatchDescReq( &destAddr, shortAddr, profileId, numInClusters,
    661                                                 inClusters, numOutClusters, outClusters, 0);
    662            }
    663          
    664            MT_BuildAndSendZToolResponse(((uint8)MT_RPC_CMD_SRSP | (uint8)MT_RPC_SYS_ZDO), cmdId, 1, &retValue);
    665          }
    666          
    667          /***************************************************************************************************
    668           * @fn      MT_ZdoComplexDescRequest
    669           *
    670           * @brief   Handle a Complex Descriptor request.
    671           *
    672           * @param   pBuf  - MT message data
    673           *
    674           * @return  void
    675           ***************************************************************************************************/
    676          void MT_ZdoComplexDescRequest(uint8 *pBuf)
    677          {
    678            uint8 cmdId;
    679            uint8 retValue;
    680            zAddrType_t destAddr;
    681            uint16 shortAddr;
    682          
    683            /* parse header */
    684            cmdId = pBuf[MT_RPC_POS_CMD1];
    685            pBuf += MT_RPC_FRAME_HDR_SZ;
    686          
    687            /* Dev address */
    688            destAddr.addrMode = Addr16Bit;
    689            destAddr.addr.shortAddr = BUILD_UINT16( pBuf[0], pBuf[1] );
    690            pBuf += 2;
    691          
    692            /* Network address of interest */
    693            shortAddr = BUILD_UINT16( pBuf[0], pBuf[1] );
    694            pBuf += 2;
    695          
    696            retValue = (uint8)ZDP_ComplexDescReq( &destAddr, shortAddr, 0);
    697          
    698            MT_BuildAndSendZToolResponse(((uint8)MT_RPC_CMD_SRSP | (uint8)MT_RPC_SYS_ZDO), cmdId, 1, &retValue);
    699          }
    700          
    701          /***************************************************************************************************
    702           * @fn      MT_ZdoUserDescRequest
    703           *
    704           * @brief   Handle a User Descriptor request.
    705           *
    706           * @param   pBuf  - MT message data
    707           *
    708           * @return  void
    709           ***************************************************************************************************/
    710          void MT_ZdoUserDescRequest(uint8 *pBuf)
    711          {
    712            uint8 cmdId;
    713            uint8 retValue;
    714            zAddrType_t destAddr;
    715            uint16 shortAddr;
    716          
    717            /* parse header */
    718            cmdId = pBuf[MT_RPC_POS_CMD1];
    719            pBuf += MT_RPC_FRAME_HDR_SZ;
    720          
    721            /* Dev address */
    722            destAddr.addrMode = Addr16Bit;
    723            destAddr.addr.shortAddr = BUILD_UINT16( pBuf[0], pBuf[1]);
    724            pBuf += 2;
    725          
    726            /* Network address of interest */
    727            shortAddr = BUILD_UINT16( pBuf[0], pBuf[1]);
    728            pBuf += 2;
    729          
    730            retValue = (uint8)ZDP_UserDescReq( &destAddr, shortAddr, 0);
    731          
    732            MT_BuildAndSendZToolResponse(((uint8)MT_RPC_CMD_SRSP | (uint8)MT_RPC_SYS_ZDO), cmdId, 1, &retValue);
    733          }
    734          
    735          /***************************************************************************************************
    736           * @fn      MT_ZdoEndDevAnnce
    737           *
    738           * @brief   Handle a End Device Announce Descriptor request.
    739           *
    740           * @param   pBuf  - MT message data
    741           *
    742           * @return  void
    743           ***************************************************************************************************/
    744          void MT_ZdoEndDevAnnce(uint8 *pBuf)
    745          {
    746            uint8 cmdId;
    747            uint8 retValue;
    748            uint16 shortAddr;
    749            uint8 *pIEEEAddr;
    750          
    751            /* parse header */
    752            cmdId = pBuf[MT_RPC_POS_CMD1];
    753            pBuf += MT_RPC_FRAME_HDR_SZ;
    754          
    755            /* network address */
    756            shortAddr = BUILD_UINT16( pBuf[0], pBuf[1] );
    757            pBuf += 2;
    758          
    759            /* extended address */
    760            pIEEEAddr = pBuf;
    761            pBuf += Z_EXTADDR_LEN;
    762          
    763            retValue = (uint8)ZDP_DeviceAnnce( shortAddr, pIEEEAddr, *pBuf, 0);
    764          
    765            MT_BuildAndSendZToolResponse(((uint8)MT_RPC_CMD_SRSP | (uint8)MT_RPC_SYS_ZDO), cmdId, 1, &retValue);
    766          }
    767          
    768          /***************************************************************************************************
    769           * @fn      MT_ZdoUserDescSet
    770           *
    771           * @brief   Handle a User Descriptor Set.
    772           *
    773           * @param   pBuf  - MT message data
    774           *
    775           * @return  void
    776           ***************************************************************************************************/
    777          void MT_ZdoUserDescSet(uint8 *pBuf)
    778          {
    779            uint8 cmdId;
    780            uint8 retValue;
    781            zAddrType_t destAddr;
    782            uint16 shortAddr;
    783            UserDescriptorFormat_t userDesc;
    784          
    785            /* parse header */
    786            cmdId = pBuf[MT_RPC_POS_CMD1];
    787            pBuf += MT_RPC_FRAME_HDR_SZ;
    788          
    789            /* Dev address */
    790            destAddr.addrMode = Addr16Bit;
    791            destAddr.addr.shortAddr = BUILD_UINT16( pBuf[0], pBuf[1] );
    792            pBuf += 2;
    793          
    794            /* Network address of interest */
    795            shortAddr = BUILD_UINT16( pBuf[0], pBuf[1] );
    796            pBuf += 2;
    797          
    798            /* User descriptor */
    799            userDesc.len = *pBuf++;
    800            osal_memcpy( userDesc.desc, pBuf, userDesc.len );
    801            pBuf += 16;
    802          
    803            retValue = (uint8)ZDP_UserDescSet( &destAddr, shortAddr, &userDesc, 0);
    804          
    805            MT_BuildAndSendZToolResponse(((uint8)MT_RPC_CMD_SRSP | (uint8)MT_RPC_SYS_ZDO), cmdId, 1, &retValue);
    806          }
    807          
    808          /***************************************************************************************************
    809           * @fn      MT_ZdoServiceDiscRequest
    810           *
    811           * @brief   Handle a Server Discovery request.
    812           *
    813           * @param   pBuf  - MT message data
    814           *
    815           * @return  void
    816           ***************************************************************************************************/
    817          void MT_ZdoServiceDiscRequest(uint8 *pBuf)
    818          {
    819            uint8 cmdId;
    820            uint8 retValue;
    821            uint16 serviceMask;
    822          
    823            /* parse header */
    824            cmdId = pBuf[MT_RPC_POS_CMD1];
    825            pBuf += MT_RPC_FRAME_HDR_SZ;
    826          
    827            /* Service Mask */
    828            serviceMask = BUILD_UINT16( pBuf[0], pBuf[1]);
    829            pBuf += 2;
    830          
    831            retValue = (uint8)ZDP_ServerDiscReq( serviceMask, 0);
    832          
    833            MT_BuildAndSendZToolResponse(((uint8)MT_RPC_CMD_SRSP | (uint8)MT_RPC_SYS_ZDO), cmdId, 1, &retValue);
    834          }
    835          
    836          /***************************************************************************************************
    837           * @fn      MT_ZdoEndDevBindRequest
    838           *
    839           * @brief   Handle a End Device Bind request.
    840           *
    841           * @param   pBuf  - MT message data
    842           *
    843           * @return  void
    844           ***************************************************************************************************/
    845          void MT_ZdoEndDevBindRequest(uint8 *pBuf)
    846          {
    847            uint8 cmdId;
    848            uint8 retValue = 0;
    849            uint8 i, epInt, numInClusters, numOutClusters;
    850            zAddrType_t destAddr;
    851            uint16 shortAddr;
    852            uint16 profileID, inClusters[MTZDO_MAX_ED_BIND_CLUSTERS], outClusters[MTZDO_MAX_ED_BIND_CLUSTERS];
    853          
    854            /* parse header */
    855            cmdId = pBuf[MT_RPC_POS_CMD1];
    856            pBuf += MT_RPC_FRAME_HDR_SZ;
    857          
    858            /* Dev address */
    859            destAddr.addrMode = Addr16Bit;
    860            destAddr.addr.shortAddr = BUILD_UINT16( pBuf[0], pBuf[1] );
    861            pBuf += 2;
    862          
    863            /* Local coordinator of the binding */
    864            shortAddr = BUILD_UINT16( pBuf[0], pBuf[1] );
    865            pBuf += 2;
    866          
    867            /* For now, skip past the extended address */
    868            pBuf += Z_EXTADDR_LEN;
    869          
    870            /* Endpoint */
    871            epInt = *pBuf++;
    872          
    873            /* Profile ID */
    874            profileID = BUILD_UINT16( pBuf[0], pBuf[1] );
    875            pBuf += 2;
    876          
    877            /* NumInClusters */
    878            numInClusters = *pBuf++;
    879            if ( numInClusters <= MTZDO_MAX_ED_BIND_CLUSTERS )
    880            {
    881              for ( i = 0; i < numInClusters; i++ )
    882              {
    883                inClusters[i] = BUILD_UINT16(pBuf[0], pBuf[1]);
    884                pBuf += 2;
    885              }
    886            }
    887            else
    888            {
    889              retValue = ZDP_INVALID_REQTYPE;
    890            }
    891          
    892            /* NumOutClusters */
    893            numOutClusters = *pBuf++;
    894            if ( numOutClusters <= MTZDO_MAX_ED_BIND_CLUSTERS )
    895            {
    896              for ( i = 0; i < numOutClusters; i++ )
    897              {
    898                outClusters[i] = BUILD_UINT16(pBuf[0], pBuf[1]);
    899                pBuf += 2;
    900              }
    901            }
    902            else
    903            {
    904              retValue = ZDP_INVALID_REQTYPE;
    905            }
    906          
    907            if ( retValue == 0 )
    908            {
    909              retValue = (uint8)ZDP_EndDeviceBindReq( &destAddr, shortAddr, epInt, profileID,
    910                                                    numInClusters, inClusters, numOutClusters, outClusters, 0);
    911            }
    912          
    913            MT_BuildAndSendZToolResponse(((uint8)MT_RPC_CMD_SRSP | (uint8)MT_RPC_SYS_ZDO), cmdId, 1, &retValue);
    914          }
    915          
    916          /***************************************************************************************************
    917           * @fn      MT_ZdoBindRequest
    918           *
    919           * @brief   Handle a Bind request.
    920           *
    921           * @param   pBuf  - MT message data
    922           *
    923           * @return  void
    924           ***************************************************************************************************/
    925          void MT_ZdoBindRequest(uint8 *pBuf)
    926          {
    927            uint8 cmdId;
    928            uint8 retValue;
    929            zAddrType_t destAddr, devAddr;
    930            uint8 *pSrcAddr, *ptr;
    931            uint8 srcEPInt, dstEPInt;
    932            uint16 clusterID;
    933          
    934            /* parse header */
    935            cmdId = pBuf[MT_RPC_POS_CMD1];
    936            pBuf += MT_RPC_FRAME_HDR_SZ;
    937          
    938            /* Dev address */
    939            destAddr.addrMode = Addr16Bit;
    940            destAddr.addr.shortAddr = BUILD_UINT16( pBuf[0], pBuf[1] );
    941            pBuf += 2;
    942          
    943            /* SrcAddress */
    944            pSrcAddr = pBuf;
    945            pBuf += Z_EXTADDR_LEN;
    946          
    947            /* SrcEPInt */
    948            srcEPInt = *pBuf++;
    949          
    950            /* ClusterID */
    951            clusterID = BUILD_UINT16( pBuf[0], pBuf[1]);
    952            pBuf += 2;
    953          
    954            /* Destination Address mode */
    955            devAddr.addrMode = *pBuf++;
    956          
    957            /* Destination Address */
    958            if ( devAddr.addrMode == Addr64Bit )
    959            {
    960              ptr = pBuf;
    961              osal_cpyExtAddr( devAddr.addr.extAddr, ptr );
    962            }
    963            else
    964            {
    965              devAddr.addr.shortAddr = BUILD_UINT16( pBuf[0], pBuf[1] );
    966            }
    967            /* The short address occupies LSB two bytes */
    968            pBuf += Z_EXTADDR_LEN;
    969          
    970            /* DstEPInt */
    971            dstEPInt = *pBuf;
    972          
    973            retValue = (uint8)ZDP_BindReq( &destAddr, pSrcAddr, srcEPInt, clusterID, &devAddr, dstEPInt, 0);
    974          
    975            MT_BuildAndSendZToolResponse(((uint8)MT_RPC_CMD_SRSP | (uint8)MT_RPC_SYS_ZDO), cmdId, 1, &retValue);
    976          }
    977          
    978          /***************************************************************************************************
    979           * @fn      MT_ZdoUnbindRequest
    980           *
    981           * @brief   Handle a Unbind request.
    982           *
    983           * @param   pBuf  - MT message data
    984           *
    985           * @return  void
    986           ***************************************************************************************************/
    987          void MT_ZdoUnbindRequest(uint8 *pBuf)
    988          {
    989            uint8 cmdId;
    990            uint8 retValue;
    991            zAddrType_t destAddr, devAddr;
    992            uint8 *pSrcAddr, *ptr;
    993            uint8 srcEPInt, dstEPInt;
    994            uint16 clusterID;
    995          
    996            /* parse header */
    997            cmdId = pBuf[MT_RPC_POS_CMD1];
    998            pBuf += MT_RPC_FRAME_HDR_SZ;
    999          
   1000            /* dev address */
   1001            destAddr.addrMode = Addr16Bit;
   1002            destAddr.addr.shortAddr = BUILD_UINT16( pBuf[0], pBuf[1] );
   1003            pBuf += 2;
   1004          
   1005            /* SrcAddress */
   1006            pSrcAddr = pBuf;
   1007            pBuf += Z_EXTADDR_LEN;
   1008          
   1009            /* SrcEPInt */
   1010            srcEPInt = *pBuf++;
   1011          
   1012            /* ClusterID */
   1013            clusterID = BUILD_UINT16( pBuf[0], pBuf[1]);
   1014            pBuf += 2;
   1015          
   1016            /* Destination Address mode */
   1017            devAddr.addrMode = *pBuf++;
   1018          
   1019            /* Destination Address */
   1020            if ( devAddr.addrMode == Addr64Bit )
   1021            {
   1022              ptr = pBuf;
   1023              osal_cpyExtAddr( devAddr.addr.extAddr, ptr );
   1024            }
   1025            else
   1026            {
   1027              devAddr.addr.shortAddr = BUILD_UINT16( pBuf[0], pBuf[1] );
   1028            }
   1029            /* The short address occupies LSB two bytes */
   1030            pBuf += Z_EXTADDR_LEN;
   1031          
   1032            /* dstEPInt */
   1033            dstEPInt = *pBuf;
   1034          
   1035            retValue = (uint8)ZDP_UnbindReq( &destAddr, pSrcAddr, srcEPInt, clusterID, &devAddr, dstEPInt, 0);
   1036          
   1037            MT_BuildAndSendZToolResponse(((uint8)MT_RPC_CMD_SRSP | (uint8)MT_RPC_SYS_ZDO), cmdId, 1, &retValue);
   1038          }
   1039          
   1040          #if defined (MT_SYS_KEY_MANAGEMENT)
   1041          /***************************************************************************************************
   1042           * @fn      MT_ZdoSetLinkKey
   1043           *
   1044           * @brief   Set an application or trust center link key.
   1045           *
   1046           * @param   pBuf  - MT message data
   1047           *
   1048           * @return  void
   1049           ***************************************************************************************************/
   1050          void MT_ZdoSetLinkKey(uint8 *pBuf)
   1051          {
   1052            uint8 cmdId;
   1053            uint8 retValue;
   1054            uint8 *pExtAddr;
   1055            uint8 *pKey;
   1056            uint16 shortAddr;
   1057          
   1058            /* parse header */
   1059            cmdId = pBuf[MT_RPC_POS_CMD1];
   1060            pBuf += MT_RPC_FRAME_HDR_SZ;
   1061          
   1062            /* ShortAddr */
   1063            shortAddr = BUILD_UINT16( pBuf[0], pBuf[1] );
   1064            pBuf += 2;
   1065          
   1066            /* Extended Addr */
   1067            pExtAddr = pBuf;
   1068            pBuf += Z_EXTADDR_LEN;
   1069          
   1070            /* Key data */
   1071            pKey = pBuf;
   1072          
   1073            retValue = (uint8)ZDSecMgrAddLinkKey( shortAddr, pExtAddr, pKey);
   1074          
   1075            MT_BuildAndSendZToolResponse(((uint8)MT_RPC_CMD_SRSP | (uint8)MT_RPC_SYS_ZDO), cmdId, 1, &retValue);
   1076          }
   1077          
   1078          /***************************************************************************************************
   1079           * @fn      MT_ZdoRemoveLinkKey
   1080           *
   1081           * @brief   Remove an application or trust center link key.
   1082           *
   1083           * @param   pBuf  - MT message data
   1084           *
   1085           * @return  void
   1086           ***************************************************************************************************/
   1087          void MT_ZdoRemoveLinkKey(uint8 *pBuf)
   1088          {
   1089            uint8 cmdId;
   1090            uint8 retValue;
   1091            uint8 *pExtAddr;
   1092          
   1093            /* parse header */
   1094            cmdId = pBuf[MT_RPC_POS_CMD1];
   1095            pBuf += MT_RPC_FRAME_HDR_SZ;
   1096          
   1097            /* ShortAddr */
   1098            pExtAddr = pBuf;
   1099          
   1100            retValue = ZDSecMgrDeviceRemoveByExtAddr( pExtAddr );
   1101          
   1102            MT_BuildAndSendZToolResponse(((uint8)MT_RPC_CMD_SRSP | (uint8)MT_RPC_SYS_ZDO), cmdId, 1, &retValue);
   1103          }
   1104          
   1105          /***************************************************************************************************
   1106           * @fn      MT_ZdoGetLinkKey
   1107           *
   1108           * @brief   Get the application link key.
   1109           *
   1110           * @param   pBuf  - MT message data
   1111           *
   1112           * @return  void
   1113           ***************************************************************************************************/
   1114          void MT_ZdoGetLinkKey(uint8 *pBuf)
   1115          {
   1116            uint8 cmdId;
   1117            uint8 retValue;
   1118            uint8 *pExtAddr;
   1119            uint8 *retBuf = NULL;
   1120            uint8 len;
   1121            APSME_LinkKeyData_t *pApsLinkKey = NULL;
   1122            uint16 apsLinkKeyNvId;
   1123          
   1124            // parse header
   1125            cmdId = pBuf[MT_RPC_POS_CMD1];
   1126            pBuf += MT_RPC_FRAME_HDR_SZ;
   1127          
   1128            // Extended Address
   1129            pExtAddr = pBuf;
   1130          
   1131            // Fetch the key NV ID
   1132            retValue = APSME_LinkKeyNVIdGet( pExtAddr, &apsLinkKeyNvId );
   1133          
   1134            if (retValue == ZSuccess)
   1135            {
   1136              if ((pApsLinkKey = (APSME_LinkKeyData_t *)osal_mem_alloc(sizeof(APSME_LinkKeyData_t))) != NULL)
   1137              {
   1138                // retrieve key from NV
   1139                if (osal_nv_read( apsLinkKeyNvId, 0,
   1140                                 sizeof(APSME_LinkKeyData_t), pApsLinkKey) != SUCCESS)
   1141                {
   1142                  retValue = ZNwkUnknownDevice;
   1143                }
   1144              }
   1145              else
   1146              {
   1147                retValue = ZNwkUnknownDevice;
   1148              }
   1149            }
   1150          
   1151            // Construct the response message
   1152            len = MT_ZDO_STATUS_LEN + Z_EXTADDR_LEN + SEC_KEY_LEN; // status + extAddr + key
   1153            if ((retBuf = (uint8 *)osal_mem_alloc(len)) != NULL)
   1154            {
   1155              if (retValue == ZSuccess)
   1156              {
   1157                // Extended Address
   1158                osal_memcpy( &(retBuf[1]), pExtAddr, Z_EXTADDR_LEN );
   1159          
   1160                // Key data
   1161                osal_memcpy( &(retBuf[1 + Z_EXTADDR_LEN]), pApsLinkKey->key, SEC_KEY_LEN );
   1162              }
   1163              else
   1164              {
   1165                // Failed case - set the rest fields to all FF
   1166                osal_memset( &(retBuf[1]), 0xFF, Z_EXTADDR_LEN + SEC_KEY_LEN );
   1167              }
   1168          
   1169              retBuf[0] = retValue;  // Status
   1170          
   1171              MT_BuildAndSendZToolResponse(((uint8)MT_RPC_CMD_SRSP | (uint8)MT_RPC_SYS_ZDO), cmdId, len, retBuf);
   1172          
   1173              // clear retBuf because it contains key data and free allocated memory
   1174              osal_memset(retBuf, 0x00, len);
   1175          
   1176              osal_mem_free(retBuf);
   1177            }
   1178          
   1179            // clear copy of key in RAM
   1180            if (pApsLinkKey != NULL)
   1181            {
   1182              osal_memset(pApsLinkKey, 0x00, sizeof(APSME_LinkKeyData_t));
   1183          
   1184              osal_mem_free(pApsLinkKey);
   1185            }
   1186          
   1187            return;
   1188          }
   1189          #endif // MT_SYS_KEY_MANAGEMENT
   1190          
   1191          #if defined (MT_ZDO_MGMT)
   1192          /***************************************************************************************************
   1193           * @fn      MT_ZdoMgmtNwkDiscRequest
   1194           *
   1195           * @brief   Handle a Mgmt Nwk Discovery request.
   1196           *
   1197           * @param   pBuf  - MT message data
   1198           *
   1199           * @return  void
   1200           ***************************************************************************************************/
   1201          void MT_ZdoMgmtNwkDiscRequest(uint8 *pBuf)
   1202          {
   1203            uint8 cmdId;
   1204            uint8 retValue;
   1205            zAddrType_t destAddr;
   1206            uint32 scanChannels;
   1207            uint8 scanDuration, startIndex;
   1208          
   1209            /* parse header */
   1210            cmdId = pBuf[MT_RPC_POS_CMD1];
   1211            pBuf += MT_RPC_FRAME_HDR_SZ;
   1212          
   1213            /* Dev address */
   1214            destAddr.addrMode = Addr16Bit;
   1215            destAddr.addr.shortAddr = BUILD_UINT16( pBuf[0], pBuf[1] );
   1216            pBuf += 2;
   1217          
   1218            /* Scan Channels */
   1219            scanChannels = BUILD_UINT32( pBuf[0], pBuf[1], pBuf[2], pBuf[3] );
   1220            pBuf += 4;
   1221          
   1222            /* Scan Duration */
   1223            scanDuration = *pBuf++;
   1224          
   1225            /* Start Index */
   1226            startIndex = *pBuf;
   1227          
   1228            retValue = (uint8)ZDP_MgmtNwkDiscReq( &destAddr, scanChannels, scanDuration, startIndex, 0);
   1229          
   1230            MT_BuildAndSendZToolResponse(((uint8)MT_RPC_CMD_SRSP | (uint8)MT_RPC_SYS_ZDO), cmdId, 1, &retValue);
   1231          }
   1232          
   1233          /***************************************************************************************************
   1234           * @fn      MT_ZdoMgmtLqiRequest
   1235           *
   1236           * @brief   Handle a Mgmt Lqi request.
   1237           *
   1238           * @param   pBuf  - MT message data
   1239           *
   1240           * @return  void
   1241           ***************************************************************************************************/
   1242          void MT_ZdoMgmtLqiRequest(uint8 *pBuf)
   1243          {
   1244            uint8 cmdId;
   1245            uint8 retValue;
   1246            zAddrType_t destAddr;
   1247            uint8 startIndex;
   1248          
   1249            /* parse header */
   1250            cmdId = pBuf[MT_RPC_POS_CMD1];
   1251            pBuf += MT_RPC_FRAME_HDR_SZ;
   1252          
   1253            /* Dev address */
   1254            destAddr.addrMode = Addr16Bit;
   1255            destAddr.addr.shortAddr = BUILD_UINT16( pBuf[0], pBuf[1] );
   1256            pBuf += 2;
   1257          
   1258            /* Start Index */
   1259            startIndex = *pBuf;
   1260          
   1261            retValue = (uint8)ZDP_MgmtLqiReq( &destAddr, startIndex, 0);
   1262          
   1263            MT_BuildAndSendZToolResponse(((uint8)MT_RPC_CMD_SRSP | (uint8)MT_RPC_SYS_ZDO), cmdId, 1, &retValue);
   1264          }
   1265          
   1266          /***************************************************************************************************
   1267           * @fn      MT_ZdoMgmtRtgRequest
   1268           *
   1269           * @brief   Handle a Mgmt Rtg request.
   1270           *
   1271           * @param   pBuf  - MT message data
   1272           *
   1273           * @return  void
   1274           ***************************************************************************************************/
   1275          void MT_ZdoMgmtRtgRequest(uint8 *pBuf)
   1276          {
   1277            uint8 cmdId;
   1278            uint8 retValue;
   1279            zAddrType_t destAddr;
   1280            uint8 startIndex;
   1281          
   1282            /* parse header */
   1283            cmdId = pBuf[MT_RPC_POS_CMD1];
   1284            pBuf += MT_RPC_FRAME_HDR_SZ;
   1285          
   1286            /* Dev Address */
   1287            destAddr.addrMode = Addr16Bit;
   1288            destAddr.addr.shortAddr = BUILD_UINT16( pBuf[0], pBuf[1]);
   1289            pBuf += 2;
   1290          
   1291            /* Start Index */
   1292            startIndex = *pBuf;
   1293          
   1294            retValue = (byte)ZDP_MgmtRtgReq( &destAddr, startIndex, 0);
   1295          
   1296            MT_BuildAndSendZToolResponse(((uint8)MT_RPC_CMD_SRSP | (uint8)MT_RPC_SYS_ZDO), cmdId, 1, &retValue);
   1297          }
   1298          
   1299          /***************************************************************************************************
   1300           * @fn      MT_ZdoMgmtBindRequest
   1301           *
   1302           * @brief   Handle a Mgmt Bind request.
   1303           *
   1304           * @param   pBuf  - MT message data
   1305           *
   1306           * @return  void
   1307           ***************************************************************************************************/
   1308          void MT_ZdoMgmtBindRequest(uint8 *pBuf)
   1309          {
   1310            uint8 cmdId;
   1311            uint8 retValue;
   1312            zAddrType_t destAddr;
   1313            uint8 startIndex;
   1314          
   1315            /* parse header */
   1316            cmdId = pBuf[MT_RPC_POS_CMD1];
   1317            pBuf += MT_RPC_FRAME_HDR_SZ;
   1318          
   1319            /* Dev Address */
   1320            destAddr.addrMode = Addr16Bit;
   1321            destAddr.addr.shortAddr = BUILD_UINT16( pBuf[0], pBuf[1] );
   1322            pBuf += 2;
   1323          
   1324            /* Start Index */
   1325            startIndex = *pBuf;
   1326          
   1327            retValue = (uint8)ZDP_MgmtBindReq( &destAddr, startIndex, 0);
   1328          
   1329            MT_BuildAndSendZToolResponse(((uint8)MT_RPC_CMD_SRSP | (uint8)MT_RPC_SYS_ZDO), cmdId, 1, &retValue);
   1330          }
   1331          
   1332          /***************************************************************************************************
   1333           * @fn      MT_ZdoMgmtLeaveRequest
   1334           *
   1335           * @brief   Handle a Mgmt Leave request.
   1336           *
   1337           * @param   pBuf  - MT message data
   1338           *
   1339           * @return  void
   1340           ***************************************************************************************************/
   1341          void MT_ZdoMgmtLeaveRequest(uint8 *pBuf)
   1342          {
   1343            uint8 cmdId;
   1344            uint8 retValue;
   1345            zAddrType_t destAddr;
   1346            uint8 *pIEEEAddr;
   1347            uint8 removeChildren, rejoin;
   1348          
   1349            /* parse header */
   1350            cmdId = pBuf[MT_RPC_POS_CMD1];
   1351            pBuf += MT_RPC_FRAME_HDR_SZ;
   1352          
   1353            /* Destination Address */
   1354            destAddr.addrMode = Addr16Bit;
   1355            destAddr.addr.shortAddr = BUILD_UINT16( pBuf[0], pBuf[1] );
   1356            pBuf += 2;
   1357          
   1358            /* IEEE address */
   1359            pIEEEAddr = pBuf;
   1360            pBuf += Z_EXTADDR_LEN;
   1361          
   1362            /* Remove Children */
   1363            removeChildren = *pBuf++;
   1364          
   1365            /* Rejoin */
   1366            rejoin = *pBuf;
   1367          
   1368            retValue = (byte)ZDP_MgmtLeaveReq( &destAddr, pIEEEAddr, removeChildren, rejoin, 0);
   1369          
   1370            MT_BuildAndSendZToolResponse(((uint8)MT_RPC_CMD_SRSP | (uint8)MT_RPC_SYS_ZDO), cmdId, 1, &retValue);
   1371          }
   1372          
   1373          
   1374          /***************************************************************************************************
   1375           * @fn      MT_ZdoMgmtDirectJoinRequest
   1376           *
   1377           * @brief   Handle a Mgmt Direct Join request.
   1378           *
   1379           * @param   pBuf  - MT message data
   1380           *
   1381           * @return  void
   1382           ***************************************************************************************************/
   1383          void MT_ZdoMgmtDirectJoinRequest(uint8 *pBuf)
   1384          {
   1385            uint8 cmdId;
   1386            uint8 retValue;
   1387            zAddrType_t destAddr;
   1388            uint8 *deviceAddr;
   1389            uint8 capInfo;
   1390          
   1391            /* parse header */
   1392            cmdId = pBuf[MT_RPC_POS_CMD1];
   1393            pBuf += MT_RPC_FRAME_HDR_SZ;
   1394          
   1395            /* Destination Address */
   1396            destAddr.addrMode = Addr16Bit;
   1397            destAddr.addr.shortAddr = BUILD_UINT16( pBuf[0], pBuf[1] );
   1398            pBuf += 2;
   1399          
   1400            /* Device Address */
   1401            deviceAddr = pBuf;
   1402            pBuf += Z_EXTADDR_LEN;
   1403          
   1404            /* Capability information */
   1405            capInfo = *pBuf;
   1406          
   1407            retValue = (uint8)ZDP_MgmtDirectJoinReq( &destAddr, deviceAddr, capInfo, 0);
   1408          
   1409            MT_BuildAndSendZToolResponse(((uint8)MT_RPC_CMD_SRSP | (uint8)MT_RPC_SYS_ZDO), cmdId, 1, &retValue);
   1410          }
   1411          
   1412          /***************************************************************************************************
   1413           * @fn      MT_ZdoMgmtPermitJoinRequest
   1414           *
   1415           * @brief   Handle a Mgmt Permit Join request.
   1416           *
   1417           * @param   pBuf  - MT message data
   1418           *
   1419           * @return  void
   1420           ***************************************************************************************************/
   1421          void MT_ZdoMgmtPermitJoinRequest(uint8 *pBuf)
   1422          {
   1423            uint8 cmdId;
   1424            uint8 retValue;
   1425            zAddrType_t destAddr;
   1426            uint8 duration, tcSignificance;
   1427          
   1428            /* parse header */
   1429            cmdId = pBuf[MT_RPC_POS_CMD1];
   1430            pBuf += MT_RPC_FRAME_HDR_SZ;
   1431          
   1432            /* Destination Address */
   1433            destAddr.addrMode = Addr16Bit;
   1434            destAddr.addr.shortAddr = BUILD_UINT16( pBuf[0], pBuf[1] );
   1435            pBuf += 2;
   1436          
   1437            /* Duration */
   1438            duration = *pBuf++;
   1439          
   1440            /* Trust center significance */
   1441            tcSignificance = *pBuf;
   1442          
   1443            retValue = (byte)ZDP_MgmtPermitJoinReq( &destAddr, duration, tcSignificance, 0);
   1444          
   1445            MT_BuildAndSendZToolResponse(((uint8)MT_RPC_CMD_SRSP | (uint8)MT_RPC_SYS_ZDO), cmdId, 1, &retValue);
   1446          }
   1447          
   1448          /***************************************************************************************************
   1449           * @fn      MT_ZdoMgmtNwkUpdateRequest
   1450           *
   1451           * @brief   Handle a Mgmt Nwk Update request.
   1452           *
   1453           * @param   pBuf  - MT message data
   1454           *
   1455           * @return  void
   1456           ***************************************************************************************************/
   1457          void MT_ZdoMgmtNwkUpdateRequest(uint8 *pBuf)
   1458          {
   1459            uint8 cmdId;
   1460            uint8 retValue;
   1461            zAddrType_t destAddr;
   1462            uint32 channelMask;
   1463            uint8 scanDuration, scanCount;
   1464            uint16 nwkManagerAddr;
   1465          
   1466              /* parse header */
   1467            cmdId = pBuf[MT_RPC_POS_CMD1];
   1468            pBuf += MT_RPC_FRAME_HDR_SZ;
   1469          
   1470            /* Destination address */
   1471            destAddr.addr.shortAddr = BUILD_UINT16( pBuf[0], pBuf[1] );
   1472            pBuf += 2;
   1473          
   1474            /* Destination address mode */
   1475            destAddr.addrMode = *pBuf++;
   1476          
   1477            channelMask = BUILD_UINT32( pBuf[0], pBuf[1], pBuf[2], pBuf[3]);
   1478            pBuf += 4;
   1479          
   1480            /* Scan duration */
   1481            scanDuration = *pBuf++;
   1482          
   1483            /* Scan count */
   1484            scanCount = *pBuf++;
   1485          
   1486            /* NWK manager address */
   1487            nwkManagerAddr = BUILD_UINT16( pBuf[0], pBuf[1] );
   1488          
   1489            /* Send the Management Network Update request */
   1490            retValue = (uint8)ZDP_MgmtNwkUpdateReq( &destAddr, channelMask, scanDuration,
   1491                                                    scanCount, _NIB.nwkUpdateId+1, nwkManagerAddr );
   1492          
   1493            /*
   1494              Since we don't recevied our own broadcast messages, we should
   1495              send a unicast copy of the message to ourself.
   1496            */
   1497            if ( destAddr.addrMode == AddrBroadcast )
   1498            {
   1499              destAddr.addrMode = Addr16Bit;
   1500              destAddr.addr.shortAddr = _NIB.nwkDevAddress;
   1501              retValue = (uint8) ZDP_MgmtNwkUpdateReq( &destAddr, channelMask, scanDuration,
   1502                                                       scanCount, _NIB.nwkUpdateId+1, nwkManagerAddr );
   1503            }
   1504          
   1505            MT_BuildAndSendZToolResponse(((uint8)MT_RPC_CMD_SRSP | (uint8)MT_RPC_SYS_ZDO), cmdId, 1, &retValue);
   1506          }
   1507          #endif /* MT_ZDO_MGMT */
   1508          
   1509          /***************************************************************************************************
   1510           * @fn      MT_ZdoStartupFromApp
   1511           *
   1512           * @brief   Handle a Startup from App request.
   1513           *
   1514           * @param   pBuf  - MT message data
   1515           *
   1516           * @return  void
   1517           ***************************************************************************************************/
   1518          void MT_ZdoStartupFromApp(uint8 *pBuf)
   1519          {
   1520            uint8 cmd0, cmd1, retValue;
   1521          
   1522            /* parse header */
   1523            cmd0 = pBuf[MT_RPC_POS_CMD0];
   1524            cmd1 = pBuf[MT_RPC_POS_CMD1];
   1525            pBuf += MT_RPC_FRAME_HDR_SZ;
   1526          
   1527            retValue = ZDOInitDevice(100);
   1528          
   1529            if (MT_RPC_CMD_SREQ == (cmd0 & MT_RPC_CMD_TYPE_MASK))
   1530            {
   1531              MT_BuildAndSendZToolResponse(((uint8)MT_RPC_CMD_SRSP|(uint8)MT_RPC_SYS_ZDO), cmd1,1, &retValue);
   1532            }
   1533          }
   1534          
   1535          
   1536          /***************************************************************************************************
   1537           * @fn      MT_ZdoNetworkDiscoveryReq
   1538           *
   1539           * @brief   Handle a ZDO Network Discovery request.
   1540           *
   1541           * @param   pBuf  - MT message data
   1542           *
   1543           * @return  void
   1544           ***************************************************************************************************/
   1545          void MT_ZdoNetworkDiscoveryReq(uint8 *pBuf)
   1546          {
   1547            uint8  retValue = ZFailure;
   1548            uint8  cmdId;
   1549            uint32 scanChannels;
   1550          
   1551            /* parse header */
   1552            cmdId = pBuf[MT_RPC_POS_CMD1];
   1553            pBuf += MT_RPC_FRAME_HDR_SZ;
   1554          
   1555            /* Packet format */
   1556            /* scan channels (4) | scan duration (1) */
   1557          
   1558            /* Scan channels */
   1559            scanChannels = osal_build_uint32(pBuf, 4);
   1560            pBuf += 4;
   1561          
   1562            retValue = ZDApp_NetworkDiscoveryReq(scanChannels, *pBuf);
   1563          
   1564            // Register ZDO callback for MT to handle the network discovery confirm
   1565            // and beacon notification confirm
   1566            ZDO_RegisterForZdoCB( ZDO_NWK_DISCOVERY_CNF_CBID, &MT_ZdoNwkDiscoveryCnfCB );
   1567            ZDO_RegisterForZdoCB( ZDO_BEACON_NOTIFY_IND_CBID, &MT_ZdoBeaconIndCB );
   1568          
   1569            /* Build and send back the response */
   1570            MT_BuildAndSendZToolResponse(((uint8)MT_RPC_CMD_SRSP | (uint8)MT_RPC_SYS_ZDO), cmdId, 1, &retValue );
   1571          }
   1572          
   1573          
   1574          /***************************************************************************************************
   1575           * @fn      MT_ZdoJoinReq
   1576           *
   1577           * @brief   Handle a ZDO Join request.
   1578           *
   1579           * @param   pBuf  - MT message data
   1580           *
   1581           * @return  void
   1582           ***************************************************************************************************/
   1583          void MT_ZdoJoinReq(uint8 *pBuf)
   1584          {
   1585            uint8  retValue = ZFailure;
   1586            uint8  cmdId;
   1587            uint16 panId;
   1588            uint16 chosenParent;
   1589          
   1590            /* parse header */
   1591            cmdId = pBuf[MT_RPC_POS_CMD1];
   1592            pBuf += MT_RPC_FRAME_HDR_SZ;
   1593          
   1594            /* Packet format */
   1595            /* channel     (1) | panID (2) | extendedPanID (8) | chosenParent (2) |
   1596             * parentDepth (1) | stackProfile  (1)
   1597             */
   1598          
   1599            panId        = BUILD_UINT16(pBuf[1], pBuf[2]);
   1600            chosenParent = BUILD_UINT16(pBuf[11], pBuf[12]);
   1601          
   1602            retValue = ZDApp_JoinReq(pBuf[0], panId, &(pBuf[3]), chosenParent, pBuf[13], pBuf[14]);
   1603          
   1604            /* Register for MT to receive Join Confirm */
   1605            ZDO_RegisterForZdoCB( ZDO_JOIN_CNF_CBID, &MT_ZdoJoinCnfCB );
   1606          
   1607            /* Build and send back the response */
   1608            MT_BuildAndSendZToolResponse(((uint8)MT_RPC_CMD_SRSP | (uint8)MT_RPC_SYS_ZDO), cmdId, 1, &retValue );
   1609          
   1610          }
   1611          
   1612          /***************************************************************************************************
   1613           * @fn          MT_ZdoNwkDiscoveryCnfCB
   1614           *
   1615           * @brief       Send an indication to inform host device the completion of
   1616           *              network discovery scan
   1617           *
   1618           * @param       pStr - pointer to a parameter and a structure of parameters
   1619           *
   1620           * @return      void
   1621           ***************************************************************************************************/
   1622          void *MT_ZdoNwkDiscoveryCnfCB ( void *pStr )
   1623          {
   1624            /* pStr: status (uint8) */
   1625            /* Packet Format */
   1626            /* Status (1) */
   1627          
   1628            // Scan completed. De-register the callback with ZDO
   1629            ZDO_DeregisterForZdoCB( ZDO_NWK_DISCOVERY_CNF_CBID );
   1630            ZDO_DeregisterForZdoCB( ZDO_BEACON_NOTIFY_IND_CBID );
   1631          
   1632            // Send the buffered beacon indication
   1633            MT_ZdoBeaconIndCB ( NULL );
   1634          
   1635            MT_BuildAndSendZToolResponse(((uint8)MT_RPC_CMD_AREQ | (uint8)MT_RPC_SYS_ZDO),
   1636                                                   MT_ZDO_NWK_DISCOVERY_CNF, 1, pStr);
   1637            return NULL;
   1638          }
   1639          
   1640          
   1641          
   1642          /***************************************************************************************************
   1643           * @fn          MT_ZdoBeaconIndCB
   1644           *
   1645           * @brief       Send an indication to host device of a beacon notification
   1646           *
   1647           * @param       pStr -  pointer to a parameter and a structure of parameters
   1648           *
   1649           * @return      void
   1650           ***************************************************************************************************/
   1651          void *MT_ZdoBeaconIndCB ( void *pStr )
   1652          {
   1653            zdoBeaconInd_t *pBeacon = pStr;
   1654            uint8 *pTmp;
   1655          
   1656            /* Packet Format */
   1657            /* devCnt (1) | device #1 (21) | device #2 (21) |... | device #n (21) */
   1658          
   1659            if( pStr != NULL)
   1660            {
   1661              if( pBeaconIndBuf == NULL )
   1662              {
   1663                // If pBeaconIndBuf has not been allocated yet
   1664                // allocate memory now with MAX_UART_TX_BUFF
   1665                if( NULL == (pBeaconIndBuf = (uint8 *)osal_mem_alloc(MT_ZDO_BEACON_IND_PACK_LEN)))
   1666                {
   1667                  // Memory failure
   1668                  return NULL;
   1669                }
   1670                pBeaconIndBuf[0] = 0; // First byte is devCnt. Initialize to 0.
   1671              }
   1672          
   1673              // Fill in the buffer with the beacon indication
   1674              pTmp = pBeaconIndBuf + (1 + pBeaconIndBuf[0] * MT_ZDO_BEACON_IND_LEN);
   1675              *pTmp++ = LO_UINT16(pBeacon->sourceAddr);
   1676              *pTmp++ = HI_UINT16(pBeacon->sourceAddr);
   1677              *pTmp++ = LO_UINT16(pBeacon->panID);
   1678              *pTmp++ = HI_UINT16(pBeacon->panID);
   1679              *pTmp++ = pBeacon->logicalChannel;
   1680              *pTmp++ = pBeacon->permitJoining;
   1681              *pTmp++ = pBeacon->routerCapacity;
   1682              *pTmp++ = pBeacon->deviceCapacity;
   1683              *pTmp++ = pBeacon->protocolVersion;
   1684              *pTmp++ = pBeacon->stackProfile;
   1685              *pTmp++ = pBeacon->LQI;
   1686              *pTmp++ = pBeacon->depth;
   1687              *pTmp++ = pBeacon->updateID;
   1688              osal_memcpy( pTmp, pBeacon->extendedPanID, Z_EXTADDR_LEN);
   1689          
   1690              pBeaconIndBuf[0] += 1; // Increment the devCnt
   1691          
   1692              // Check if the buffer can fit in another beacon
   1693              if( ((pBeaconIndBuf[0] + 1) * MT_ZDO_BEACON_IND_LEN + 1) > MT_ZDO_BEACON_IND_PACK_LEN )
   1694              {
   1695                // Packet full, send the packet over MT
   1696                MT_BuildAndSendZToolResponse(((uint8)MT_RPC_CMD_AREQ | (uint8)MT_RPC_SYS_ZDO),
   1697                                             MT_ZDO_BEACON_NOTIFY_IND,
   1698                                             (pBeaconIndBuf[0] * MT_ZDO_BEACON_IND_LEN + 1), pBeaconIndBuf);
   1699                pBeaconIndBuf[0] = 0; // Reset the devCnt back to zero
   1700              }
   1701            }
   1702            else
   1703            {
   1704              if( (pBeaconIndBuf != NULL) && (pBeaconIndBuf[0] != 0) )
   1705              {
   1706                // End of beacon indication, send the packet over MT
   1707                MT_BuildAndSendZToolResponse(((uint8)MT_RPC_CMD_AREQ | (uint8)MT_RPC_SYS_ZDO),
   1708                                             MT_ZDO_BEACON_NOTIFY_IND,
   1709                                             (pBeaconIndBuf[0] * MT_ZDO_BEACON_IND_LEN + 1), pBeaconIndBuf);
   1710              }
   1711              // Free the allocated memory
   1712              if(pBeaconIndBuf != NULL)
   1713              {
   1714                osal_mem_free(pBeaconIndBuf);
   1715                pBeaconIndBuf = NULL;
   1716              }
   1717            }
   1718          
   1719            return NULL;
   1720          }
   1721          
   1722          
   1723          
   1724          /***************************************************************************************************
   1725           * @fn          MT_ZdoJoinCnfCB
   1726           *
   1727           * @brief       Handle the ZDO Join Confirm from ZDO
   1728           *
   1729           * @param       pStr - pointer to a parameter and a structure of parameters
   1730           *
   1731           * @return      void
   1732           ***************************************************************************************************/
   1733          void *MT_ZdoJoinCnfCB ( void *pStr )
   1734          {
   1735            /* pStr: zdoJoinCnf_t* */
   1736            /* Packet Format */
   1737            /* Status (1) | device addr (2) | parent addr (2) */
   1738          
   1739            uint8 buf[MT_ZDO_JOIN_CNF_LEN];
   1740            zdoJoinCnf_t *joinCnf = pStr;
   1741          
   1742            /* Join Complete. De-register the callback with ZDO */
   1743            ZDO_DeregisterForZdoCB( ZDO_JOIN_CNF_CBID );
   1744          
   1745            buf[0] = joinCnf->status;
   1746            buf[1] = LO_UINT16( joinCnf->deviceAddr );
   1747            buf[2] = HI_UINT16( joinCnf->deviceAddr );
   1748            buf[3] = LO_UINT16( joinCnf->parentAddr );
   1749            buf[4] = HI_UINT16( joinCnf->parentAddr );
   1750          
   1751            MT_BuildAndSendZToolResponse(((uint8)MT_RPC_CMD_AREQ | (uint8)MT_RPC_SYS_ZDO),
   1752                                         MT_ZDO_JOIN_CNF, MT_ZDO_JOIN_CNF_LEN, buf);
   1753          
   1754            return NULL;
   1755          }
   1756          
   1757          /*************************************************************************************************
   1758           * @fn      MT_ZdoRegisterForZDOMsg(pBuf);
   1759           *
   1760           * @brief   MT proxy for ZDO_RegisterForZDOMsg.
   1761           *
   1762           * @param   pBuf  - MT message data
   1763           *
   1764           * @return  void
   1765           *************************************************************************************************/
   1766          void MT_ZdoRegisterForZDOMsg(uint8 *pBuf)
   1767          {
   1768            uint8 cmd0, cmd1, tmp;
   1769            uint16 cId;
   1770          
   1771            /* parse header */
   1772            cmd0 = pBuf[MT_RPC_POS_CMD0];
   1773            cmd1 = pBuf[MT_RPC_POS_CMD1];
   1774            pBuf += MT_RPC_FRAME_HDR_SZ;
   1775          
   1776            cId = BUILD_UINT16(pBuf[0], pBuf[1]);
   1777            tmp = ZDO_RegisterForZDOMsg(MT_TaskID, cId);
   1778          
   1779            if (MT_RPC_CMD_SREQ == (cmd0 & MT_RPC_CMD_TYPE_MASK))
   1780            {
   1781              MT_BuildAndSendZToolResponse(((uint8)MT_RPC_CMD_SRSP|(uint8)MT_RPC_SYS_ZDO), cmd1, 1, &tmp);
   1782            }
   1783          }
   1784          
   1785          /*************************************************************************************************
   1786           * @fn      MT_ZdoRemoveRegisteredCB(pBuf);
   1787           *
   1788           * @brief   MT proxy for ZDO_RemoveRegisteredCB.
   1789           *
   1790           * @param   pBuf  - MT message data
   1791           *
   1792           * @return  void
   1793           *************************************************************************************************/
   1794          void MT_ZdoRemoveRegisteredCB(uint8 *pBuf)
   1795          {
   1796            uint8 cmd0, cmd1, tmp;
   1797            uint16 cId;
   1798          
   1799            /* parse header */
   1800            cmd0 = pBuf[MT_RPC_POS_CMD0];
   1801            cmd1 = pBuf[MT_RPC_POS_CMD1];
   1802            pBuf += MT_RPC_FRAME_HDR_SZ;
   1803          
   1804            cId = BUILD_UINT16(pBuf[0], pBuf[1]);
   1805            tmp = ZDO_RemoveRegisteredCB(MT_TaskID, cId);
   1806          
   1807            if (MT_RPC_CMD_SREQ == (cmd0 & MT_RPC_CMD_TYPE_MASK))
   1808            {
   1809              MT_BuildAndSendZToolResponse(((uint8)MT_RPC_CMD_SRSP|(uint8)MT_RPC_SYS_ZDO), cmd1, 1, &tmp);
   1810            }
   1811          }
   1812          
   1813          #endif /* MT_ZDO_FUNC */
   1814          
   1815          
   1816          /***************************************************************************************************
   1817           * Callback handling function
   1818           ***************************************************************************************************/
   1819          
   1820          #if defined (MT_ZDO_CB_FUNC)
   1821          
   1822          /***************************************************************************************************
   1823           * @fn      MT_ZdoStateChangeCB
   1824           *
   1825           * @brief   Handle state change OSAL message from ZDO.
   1826           *
   1827           * @param   pMsg  - Message data
   1828           *
   1829           * @return  void
   1830           */
   1831          void MT_ZdoStateChangeCB(osal_event_hdr_t *pMsg)
   1832          {
   1833            MT_BuildAndSendZToolResponse(((uint8)MT_RPC_CMD_AREQ | (uint8)MT_RPC_SYS_ZDO),
   1834                                                 MT_ZDO_STATE_CHANGE_IND, 1, &pMsg->status);
   1835          }
   1836          
   1837          /***************************************************************************************************
   1838           * @fn     MT_ZdoDirectCB()
   1839           *
   1840           * @brief  ZDO direct callback.  Build an MT message directly from the
   1841           *         over-the-air ZDO message.
   1842           *
   1843           * @param  pData - Incoming AF frame.
   1844           *
   1845           * @return  none
   1846           ***************************************************************************************************/
   1847          void MT_ZdoDirectCB( afIncomingMSGPacket_t *pData,  zdoIncomingMsg_t *inMsg )
   1848          {
   1849            uint8 len, *pBuf;
   1850            uint16 origClusterId;
   1851          
   1852            // save original value because MT_ZdoHandleExceptions() function could modify pData->clusterId
   1853            origClusterId = pData->clusterId;
   1854          
   1855            // Is the message an exception or not a response?
   1856            if ( MT_ZdoHandleExceptions( pData, inMsg ) || ( (origClusterId & ZDO_RESPONSE_BIT) == 0 ) )
   1857            {
   1858              return;  // Handled somewhere else or not needed.
   1859            }
   1860          
   1861            /* ZDO data starts after one-byte sequence number and the msg buffer length includes
   1862             * two bytes for srcAddr.
   1863             */
   1864            len = pData->cmd.DataLength - 1 + sizeof(uint16);
   1865          
   1866            if (NULL != (pBuf = (uint8 *)osal_mem_alloc(len)))
   1867            {
   1868              uint8 id = MT_ZDO_CID_TO_AREQ_ID(pData->clusterId);
   1869          
   1870              pBuf[0] = LO_UINT16(pData->srcAddr.addr.shortAddr);
   1871              pBuf[1] = HI_UINT16(pData->srcAddr.addr.shortAddr);
   1872          
   1873              /* copy ZDO data, skipping one-byte sequence number */
   1874              osal_memcpy(pBuf+2, (pData->cmd.Data + 1), pData->cmd.DataLength-1);
   1875          
   1876              MT_BuildAndSendZToolResponse(((uint8)MT_RPC_CMD_AREQ | (uint8)MT_RPC_SYS_ZDO), id, len, pBuf);
   1877              osal_mem_free(pBuf);
   1878            }
   1879          }
   1880          
   1881          /***************************************************************************************************
   1882           * @fn     MT_ZdoHandleExceptions()
   1883           *
   1884           * @brief  Handles all messages that are an exception to the generic MT ZDO Response.
   1885           *
   1886           * @param  pData - Incoming AF frame.
   1887           *
   1888           * @return  TRUE if handled by this function, FALSE if not
   1889           ***************************************************************************************************/
   1890          uint8 MT_ZdoHandleExceptions( afIncomingMSGPacket_t *pData, zdoIncomingMsg_t *inMsg )
   1891          {
   1892            uint8 ret = TRUE;
   1893            ZDO_NwkIEEEAddrResp_t *nwkRsp = NULL;
   1894            ZDO_DeviceAnnce_t devAnnce;
   1895            uint8 doDefault = FALSE;
   1896          
   1897            switch ( inMsg->clusterID )
   1898            {
   1899              case NWK_addr_rsp:
   1900              case IEEE_addr_rsp:
   1901                nwkRsp = ZDO_ParseAddrRsp( inMsg );
   1902                MT_ZdoAddrRspCB( nwkRsp, inMsg->clusterID );
   1903                if ( nwkRsp )
   1904                {
   1905                  osal_mem_free( nwkRsp );
   1906                }
   1907                break;
   1908          
   1909              case Device_annce:
   1910                ZDO_ParseDeviceAnnce( inMsg, &devAnnce );
   1911                MT_ZdoEndDevAnnceCB( &devAnnce, inMsg->srcAddr.addr.shortAddr );
   1912                break;
   1913          
   1914              case Simple_Desc_rsp:
   1915                if ( pData->cmd.DataLength > 5 )
   1916                {
   1917                  ret = FALSE;
   1918                }
   1919                else
   1920                {
   1921                  doDefault = TRUE;
   1922                }
   1923                break;
   1924          
   1925              default:
   1926                ret = FALSE;
   1927                break;
   1928            }
   1929          
   1930            if ( doDefault )
   1931            {
   1932              ret = FALSE;
   1933              pData->clusterId = MtZdoDef_rsp;
   1934              pData->cmd.DataLength = 2;
   1935            }
   1936          
   1937            return ( ret );
   1938          }
   1939          
   1940          /***************************************************************************************************
   1941           * @fn      MT_ZdoAddrRspCB
   1942           *
   1943           * @brief   Handle IEEE or nwk address response OSAL message from ZDO.
   1944           *
   1945           * @param   pMsg  - Message data
   1946           *
   1947           * @return  void
   1948           */
   1949          void MT_ZdoAddrRspCB( ZDO_NwkIEEEAddrResp_t *pMsg, uint16 clusterID )
   1950          {
   1951            uint8   listLen, len, *pBuf;
   1952          
   1953            /* both ZDO_NwkAddrResp_t and ZDO_IEEEAddrResp_t must be the same */
   1954          
   1955            /* get length, sanity check length */
   1956            listLen = pMsg->numAssocDevs;
   1957          
   1958            /* calculate msg length */
   1959            len = MT_ZDO_ADDR_RSP_LEN + (listLen * sizeof(uint16));
   1960          
   1961            /* get buffer */
   1962            if (NULL != (pBuf = (uint8 *)osal_mem_alloc(len)))
   1963            {
   1964              uint8 id = MT_ZDO_CID_TO_AREQ_ID(clusterID);
   1965              uint8 *pTmp = pBuf;
   1966          
   1967              *pTmp++ = pMsg->status;
   1968          
   1969              osal_cpyExtAddr(pTmp, pMsg->extAddr);
   1970              pTmp += Z_EXTADDR_LEN;
   1971          
   1972              *pTmp++ = LO_UINT16(pMsg->nwkAddr);
   1973              *pTmp++ = HI_UINT16(pMsg->nwkAddr);
   1974          
   1975              *pTmp++ = pMsg->startIndex;
   1976              *pTmp++ = listLen;
   1977          
   1978              MT_Word2Buf(pTmp, pMsg->devList, listLen);
   1979          
   1980              MT_BuildAndSendZToolResponse(((uint8)MT_RPC_CMD_AREQ | (uint8)MT_RPC_SYS_ZDO), id, len, pBuf);
   1981              osal_mem_free(pBuf);
   1982            }
   1983          }
   1984          
   1985          /***************************************************************************************************
   1986           * @fn      MT_ZdoEndDevAnnceCB
   1987           *
   1988           * @brief   Handle end device announce OSAL message from ZDO.
   1989           *
   1990           * @param   pMsg  - Message data
   1991           *
   1992           * @return  void
   1993           */
   1994          void MT_ZdoEndDevAnnceCB( ZDO_DeviceAnnce_t *pMsg, uint16 srcAddr )
   1995          {
   1996            uint8 *pBuf;
   1997          
   1998            if (NULL != (pBuf = (uint8 *)osal_mem_alloc(MT_ZDO_END_DEVICE_ANNCE_IND_LEN)))
   1999            {
   2000              uint8 *pTmp = pBuf;
   2001          
   2002              *pTmp++ = LO_UINT16(srcAddr);
   2003              *pTmp++ = HI_UINT16(srcAddr);
   2004          
   2005              *pTmp++ = LO_UINT16(pMsg->nwkAddr);
   2006              *pTmp++ = HI_UINT16(pMsg->nwkAddr);
   2007          
   2008              osal_cpyExtAddr(pTmp, pMsg->extAddr);
   2009              pTmp += Z_EXTADDR_LEN;
   2010          
   2011              *pTmp = pMsg->capabilities;
   2012          
   2013              MT_BuildAndSendZToolResponse(((uint8)MT_RPC_CMD_AREQ | (uint8)MT_RPC_SYS_ZDO),
   2014                                                   MT_ZDO_END_DEVICE_ANNCE_IND,
   2015                                                   MT_ZDO_END_DEVICE_ANNCE_IND_LEN, pBuf);
   2016              osal_mem_free(pBuf);
   2017            }
   2018          }
   2019          
   2020          /***************************************************************************************************
   2021           * @fn      MT_ZdoSrcRtgCB
   2022           *
   2023           * @brief   Handle Src Route from ZDO.
   2024           *
   2025           * @param   pStr  - pointer to the data structure for the src route
   2026           *
   2027           * @return  void*
   2028           */
   2029          void* MT_ZdoSrcRtgCB( void *pStr )
   2030          {
   2031            uint8 len, *pBuf;
   2032            zdoSrcRtg_t *pSrcRtg = pStr;
   2033          
   2034            // srcAddr (2) + relayCnt (1) + relayList( relaycnt * 2 )
   2035            len = 2 + 1 + pSrcRtg->relayCnt * sizeof(uint16);
   2036          
   2037            if (NULL != (pBuf = (uint8 *)osal_mem_alloc(len)))
   2038            {
   2039              uint8 idx, *pTmp = pBuf;
   2040              uint16 *pRelay;
   2041          
   2042              // Packet payload
   2043              *pTmp++ = LO_UINT16(pSrcRtg->srcAddr);
   2044              *pTmp++ = HI_UINT16(pSrcRtg->srcAddr);
   2045              *pTmp++ = pSrcRtg->relayCnt;
   2046          
   2047              // Relay List
   2048              if( ( pRelay = pSrcRtg->pRelayList ) != NULL )
   2049              {
   2050                for( idx = 0; idx < pSrcRtg->relayCnt; idx ++ )
   2051                {
   2052                  *pTmp++ = LO_UINT16(*pRelay);
   2053                  *pTmp++ = HI_UINT16(*pRelay);
   2054                  pRelay++;
   2055                }
   2056              }
   2057              MT_BuildAndSendZToolResponse(((uint8)MT_RPC_CMD_AREQ | (uint8)MT_RPC_SYS_ZDO),
   2058                                                   MT_ZDO_SRC_RTG_IND, len, pBuf);
   2059              osal_mem_free(pBuf);
   2060            }
   2061          
   2062            return NULL;
   2063          }
   2064          
   2065          /***************************************************************************************************
   2066           * @fn          MT_ZdoConcentratorIndCB
   2067           *
   2068           * @brief       Handle the ZDO Concentrator Indication callback from the ZDO.
   2069           *
   2070           * @param       pStr - pointer to a parameter and a structure of parameters
   2071           *
   2072           * @return      NULL
   2073           ***************************************************************************************************/
   2074          static void *MT_ZdoConcentratorIndCB(void *pStr)
   2075          {
   2076            uint8 buf[MT_ZDO_CONCENTRATOR_IND_LEN], *pTmp = buf;
   2077            zdoConcentratorInd_t *pInd = (zdoConcentratorInd_t *)pStr;
   2078          
   2079            *pTmp++ = LO_UINT16(pInd->nwkAddr);
   2080            *pTmp++ = HI_UINT16(pInd->nwkAddr);
   2081            pTmp = osal_memcpy(pTmp, pInd->extAddr, Z_EXTADDR_LEN);
   2082            *pTmp = pInd->pktCost;
   2083          
   2084            MT_BuildAndSendZToolResponse(((uint8)MT_RPC_CMD_AREQ | (uint8)MT_RPC_SYS_ZDO),
   2085                                              MT_ZDO_CONCENTRATOR_IND_CB, MT_ZDO_CONCENTRATOR_IND_LEN, buf);
   2086            return NULL;
   2087          }
   2088          #endif // MT_ZDO_CB_FUNC
   2089          
   2090          /***************************************************************************************************
   2091           * @fn      MT_ZdoSendMsgCB
   2092           *
   2093           * @brief   Proxy the ZDO_SendMsgCBs one message at a time.
   2094           *
   2095           * @param   pMsg  - Message data
   2096           *
   2097           * @return  void
   2098           */
   2099          void MT_ZdoSendMsgCB(zdoIncomingMsg_t *pMsg)
   2100          {
   2101            uint8 len = pMsg->asduLen + 9;
   2102            uint8 *pBuf = (uint8 *)osal_mem_alloc(len);
   2103          
   2104            if (pBuf != NULL)
   2105            {
   2106              uint8 *pTmp = pBuf;
   2107          
   2108              // Assuming exclusive use of network short addresses.
   2109              *pTmp++ = LO_UINT16(pMsg->srcAddr.addr.shortAddr);
   2110              *pTmp++ = HI_UINT16(pMsg->srcAddr.addr.shortAddr);
   2111              *pTmp++ = pMsg->wasBroadcast;
   2112              *pTmp++ = LO_UINT16(pMsg->clusterID);
   2113              *pTmp++ = HI_UINT16(pMsg->clusterID);
   2114              *pTmp++ = pMsg->SecurityUse;
   2115              *pTmp++ = pMsg->TransSeq;
   2116              // Skipping asduLen since it can be deduced from the RPC packet length.
   2117              *pTmp++ = LO_UINT16(pMsg->macDestAddr);
   2118              *pTmp++ = HI_UINT16(pMsg->macDestAddr);
   2119              (void)osal_memcpy(pTmp, pMsg->asdu, pMsg->asduLen);
   2120          
   2121              MT_BuildAndSendZToolResponse(((uint8)MT_RPC_CMD_AREQ | (uint8)MT_RPC_SYS_ZDO),
   2122                                                   MT_ZDO_MSG_CB_INCOMING, len, pBuf);
   2123          
   2124              osal_mem_free(pBuf);
   2125            }
   2126          }
   2127          
   2128          #endif   /*ZDO Command Processing in MT*/
   2129          /***************************************************************************************************
   2130          ***************************************************************************************************/


 
 
 0 bytes of memory

Errors: none
Warnings: none
